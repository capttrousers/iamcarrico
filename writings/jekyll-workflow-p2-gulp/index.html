<!DOCTYPE html><!--[if lt IE 9]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class="no-js" lang="en-us"><!--<![endif]--><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Jekyll Workflow Part 2: Automation with Gulp</title><meta name="viewport" content="width=device-width,initial-scale=1"><meta property="og:title" content="Jekyll Workflow Part 2: Automation with Gulp"><meta property="og:type" content="article"><meta property="article:published_time" content="2014-08-28T04:00:00-05:00"><meta property="article:author" content="http://iamcarrico.com/about/"><meta property="og:url" content="http://iamcarrico.com/writings/jekyll-workflow-p2-gulp/"><link rel="canonical" href="/writings/jekyll-workflow-p2-gulp/"><meta property="og:image" content="http://iamcarrico.com/img/2014/gulpjs.png"><meta property="article:tag" content="jekyll"><meta property="article:tag" content="gulp"><esi:include src="/header.php"></head><body><header><h1 class="site-name title"><a href="/"><span class="word">I.</span><span class="word">Am.</span><span class="word">Carrico.</span></a></h1><nav id="nav" role="navigation"><div class="menubar" role="menubar"><a class="menuitem" role="menuitem" href="/">Home</a> <a class="menuitem" role="menuitem" href="/about/">About</a> <a class="menuitem" role="menuitem" href="/contact/">Contact</a> <a class="menuitem" role="menuitem" href="/talks/">Talks</a></div></nav></header><main role="main"><article class="blog-post full"><h1 class="title">Jekyll Workflow Part 2: Automation with Gulp</h1><div class="metadatas"><span class="categories"><span class="category">jekyll</span> <span class="category">gulp</span></span> -  <span class="date">2014-08-28</span></div><div class="content"><p><img src="/img/2014/gulpjs.png" alt="Gulp.js"> The <a href="/writings/jekyll-workflow-p1-building/">first blog post</a> in this series talked about how to use the <a href="https://github.com/iamcarrico/generator-poole">Mr. Poole Generator</a> to create a custom Jekyll site. The generator packs in many features to create amazing blogs or static sites. Probably the most powerful portion of the generator is the <a href="http://gulpjs.com">Gulp.js</a> tasks that come bundled in the <a href="https://github.com/iamcarrico/gulp-poole">Gulp tools for Poole</a>.</p><p>This post will go over the main tasks that Mr. Poole runs, and how they were made. The source code can be found completely at https://github.com/iamcarrico/gulp-poole. The package is also published to npm, therefore it can be installed on any project.</p><h2 id="sass-compiling">Sass Compiling</h2><p>Mr. Poole uses <a href="http://compass-style.org/">Compass</a> to compile our Sass files. He uses several npm tasks to make our lives a little easier, minifying our CSS and adding in vendor-prefixes without having to use Compass's mixins. To start, grab the required npm packages, and add them to your gulpfile.js.</p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">paths</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'compass-options'</span><span class="p">).</span><span class="nx">dirs</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">compass</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'gulp-compass'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'gulp-autoprefixer'</span><span class="p">);</span>
</code></pre></div><p>The task itself pulls the current paths from Compass's config.rb file. Gulp then sources those files, and pipes them to Compass. A few important pieces to note here is that we have <code>bundle_exec: true</code> to ensure that Compass runs through bundler. Next, we send the compiled CSS files through <a href="https://github.com/ai/autoprefixer">autoprefixer</a> to ensure we have the proper vendor prefixes on our CSS. Finally, we send the compiled and prefixed CSS to the local css directory and the assets directory used by Jekyll. Finally, we trigger <a href="#browsersync">BrowserSync</a> to reload the CSS files within the browser.</p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">'sass'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">browserSync</span><span class="p">.</span><span class="nx">notify</span><span class="p">(</span><span class="s1">'&lt;span style="color: grey"&gt;Running:&lt;/span&gt; Sass compiling'</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="nx">paths</span><span class="p">.</span><span class="nx">sass</span> <span class="o">+</span> <span class="s1">'/**/*.scss'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">compass</span><span class="p">({</span>
      <span class="nx">config_file</span><span class="o">:</span> <span class="s1">'./config.rb'</span><span class="p">,</span>
      <span class="nx">css</span><span class="o">:</span> <span class="nx">paths</span><span class="p">.</span><span class="nx">css</span><span class="p">,</span>
      <span class="nx">sass</span><span class="o">:</span> <span class="nx">paths</span><span class="p">.</span><span class="nx">sass</span><span class="p">,</span>
      <span class="nx">bundle_exec</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">time</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">}))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">prefix</span><span class="p">(</span><span class="s2">"last 2 versions"</span><span class="p">,</span> <span class="s2">"&gt; 1%"</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="nx">paths</span><span class="p">.</span><span class="nx">css</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="nx">paths</span><span class="p">.</span><span class="nx">assets</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">browserSync</span><span class="p">.</span><span class="nx">reload</span><span class="p">({</span><span class="nx">stream</span><span class="o">:</span><span class="kc">true</span><span class="p">}));</span>
<span class="p">});</span>
</code></pre></div><p>This task, just like any of the tasks within the gulpfile, can be overriden with ones within your project's own gulpfile. Just ensure that the task name is the same as the task in Mr. Poole's gulpfile.</p><h2 id="image-minification">Image Minification</h2><p>To minify images, Mr. Poole first checks to see if any images have changed since the task last ran. If any changes have occurred, then he will minify the changed images. This will prevent images from being repeatedly minified, causing extra processing time.</p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">changed</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'gulp-changed'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">imagemin</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'gulp-imagemin'</span><span class="p">);</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">'images'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">(</span><span class="nx">paths</span><span class="p">.</span><span class="nx">imagesSrc</span> <span class="o">+</span> <span class="s1">'/**/*'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">changed</span><span class="p">(</span><span class="nx">paths</span><span class="p">.</span><span class="nx">img</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">imagemin</span><span class="p">({</span><span class="nx">optimizationLevel</span><span class="o">:</span> <span class="mi">5</span><span class="p">}))</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="nx">paths</span><span class="p">.</span><span class="nx">img</span><span class="p">));</span>
<span class="p">});</span>
</code></pre></div><h2 id="jekyll-development">Jekyll Development</h2><p>The site that we are building is definitely Jekyll, and Mr. Poole will ensure that we have a proper site for production and for development. He does this by giving two different <code>_config.yml</code> files, one for production and one with overrides for development. By default, Jekyll will pull the <code>_config.yml</code>, but our Gulp command will also grab the <code>_config.dev.yml</code> for local development.</p><p>By default, Mr. Poole will turn off minification for stylesheets and JavaScript, show draft content, and hide anything in the analytics.html file. Any other variable within the config file can also be overridden just by adding values to the <code>_config.dev.yml</code>.</p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">'jekyll-dev'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">browserSync</span><span class="p">.</span><span class="nx">notify</span><span class="p">(</span><span class="s1">'&lt;span style="color: grey"&gt;Running:&lt;/span&gt; $ jekyll build'</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">cp</span><span class="p">.</span><span class="nx">spawn</span><span class="p">(</span><span class="s1">'bundle'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'exec'</span><span class="p">,</span> <span class="s1">'jekyll'</span><span class="p">,</span> <span class="s1">'build'</span><span class="p">,</span> <span class="s1">'--config=_config.yml,_config.dev.yml'</span><span class="p">],</span> <span class="p">{</span><span class="nx">stdio</span><span class="o">:</span> <span class="s1">'inherit'</span><span class="p">})</span>
    <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'close'</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div><p>The Gulp task itself just runs the <code>jekyll build</code> command, as we would do normally if we were not using Gulp. Mr. Poole always wants to make sure we are using the right gems as well, so he will always choose to run commands through <a href="http://bundler.io/">Bundler</a>.</p><h2 id="watching-file-changes">Watching File Changes</h2><p>All of these tasks wouldn't be useful without Gulp also watching our files, ensuring that any changes in files will re-run Gulp tasks. Gulp makes this incredibly simple just by the <code>gulp.watch()</code>. The command takes two arguments, the first is the paths to watch, the second is the command (or array of commands) to run.</p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">'watch'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="nx">paths</span><span class="p">.</span><span class="nx">sass</span> <span class="o">+</span> <span class="s1">'/**/*.scss'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'sass'</span><span class="p">]);</span>
  <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="nx">paths</span><span class="p">.</span><span class="nx">imagesSrc</span> <span class="o">+</span> <span class="s1">'/**/*'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">runSequence</span><span class="p">([</span><span class="s1">'images'</span><span class="p">],</span> <span class="p">[</span><span class="s1">'jekyll-rebuild'</span><span class="p">])</span>
  <span class="p">});</span>
  <span class="nx">gulp</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="nx">paths</span><span class="p">.</span><span class="nx">jekyll</span><span class="p">,</span> <span class="p">[</span><span class="s1">'jekyll-rebuild'</span><span class="p">]);</span>
<span class="p">});</span>
</code></pre></div><p>The task for images utilizes <a href="https://github.com/OverZealous/run-sequence">run-sequence</a> to ensure the images are minfied before being updated in the Jekyll site.</p><h2 id="browsersync">BrowserSync</h2><p>The magic that pulls everything together, is <a href="http://www.browsersync.io/">BrowserSync</a>. Instead of using the Jekyll's built in server, BrowserSync will act as the web server. BrowserSync will also ensure that any updated files will be automatically reloaded into the browser, without the need to refresh. BrowserSync also makes it easy to test multiple devices by ensuring any clicks in one browser are replicated in all other connected browsers.</p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">'browserSync'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">browserSync</span><span class="p">({</span>
      <span class="nx">server</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">baseDir</span><span class="o">:</span> <span class="s2">"_site"</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
</code></pre></div><p>The task itself is just as simple as ensuring the server will be ran from Jekyll's <code>_site</code> directory. By running <code>gulp server</code>, Gulp will run all the previous tasks, including BrowserSync, and launch a browser with the appropriate IP and ports. In the previous tasks, the <code>browserSync.notify()</code> function will send some HTML to the browser, alerting the user of any changes that are happening.</p><h2 id="how-can-i-use-it?">How can I use it?</h2><p>The <a href="https://github.com/iamcarrico/generator-poole">Mr. Poole Yeoman Generator</a> is setup to automatically allow the use of these commands. To use it on an existing Jekyll site, copy these commands into your own Gulpfile. You can also install the commands locally with:</p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>npm install -g gulp-poole
</code></pre></div><p>and put the following code in the top of your Gulpfile:</p><div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">gulp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'gulp'</span><span class="p">);</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">'gulp-poole'</span><span class="p">)(</span><span class="nx">gulp</span><span class="p">);</span>
</code></pre></div><p>The full source code for the Gulp tools in Mr. Poole can be found on my GitHub page at https://github.com/iamcarrico/gulp-poole.</p></div><div class="comments"><div id="disqus_thread"></div><script>var disqus_shortname="iamcarrico";(function(){var dsq=document.createElement("script");dsq.type="text/javascript";dsq.async=true;dsq.src="//"+disqus_shortname+".disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(dsq)})()</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div></article></main><footer role="contentinfo"><div class="inner"><span class="contact"><a href="http://github.com/iamcarrico/" target="_blank" class="github">github.com/iamcarrico</a> <a href="http://twitter.com/iamcarrico/" target="_blank" class="twitter">twitter.com/iamcarrico</a> <a href="http://about.me/iancarrico" target="_blank" class="about-me">about.me/iancarrico</a></span><span class="copyright">© 2015 Ian Carrico</span></div></footer><script>(function(i,s,o,g,r,a,m){i.GoogleAnalyticsObject=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,"script","//www.google-analytics.com/analytics.js","ga");ga("create","UA-40742161-1","iamcarrico.com");ga("send","pageview")</script></body></html>